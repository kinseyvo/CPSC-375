# CPSC 375 Project## Authors:#   Angela DeLeo#   Roman Saddi#   Kinsey Vo#------------------------------------------------------------------------------## Packageslibrary(tidyverse)library(ggplot2)library(modelr)##----------------------- 1. DATA WRANGLING ----------------------------------### Read the data into variablescovid_data <- read_csv("owid-covid-data.csv")population_data <- read_csv("population-data.csv")# Tidy covid data as per rubriccovid_data <- covid_data %>% filter(nchar(iso_code) == 3)covid_data <- covid_data %>% filter(population >= 1000000)# Add new column: new_deaths_smoothed_2wk which will be our dependent variablecovid_data <- covid_data %>%  mutate(new_deaths_smoothed_2wk = new_deaths_smoothed +            lead(new_deaths_smoothed, 14))# Tidy population data to follow covid data and prepare for mergepopulation_data <- population_data %>% filter(nchar(`Country Code`) == 3)# Using pivot wider as the data is not tidy, it is in long format. We want it in# wide format so each variable is a column.population_data <- population_data %>%  select(-`Series Name`) %>%   pivot_wider(names_from = `Series Code`,               values_from = `2023 [YR2023]` )population_data <- population_data %>%   filter(as.integer(SP.POP.TOTL, na.rm = TRUE) >= 1000000)# Merge covid data and population data into one tablemerged_data <- full_join(covid_data, population_data,                          by = c("iso_code" = "Country Code"))# Sort data to view it as it looks on the rubricmerged_data <- merged_data %>%  select(iso_code, location, date, new_deaths_smoothed_2wk, new_cases,          new_cases_smoothed, total_vaccinations, SP.DYN.LE00.IN, SP.URB.TOTL,          SP.POP.TOTL, SP.POP.80UP.FE, SP.POP.80UP.MA, everything())##----------------------------- SCATTERPLOTS ---------------------------------### Scatterplot 1# Most recent new deaths per day two weeks ahead and the corresponding new cases # per day (new_cases_smoothed) for every countryggplot(merged_data, aes(x = new_cases_smoothed, y = new_deaths_smoothed_2wk)) +   geom_point() +   labs(x = "New Cases Smoothed", y = "New Deaths Smoothed (2 Weeks Away)",        title = "New Cases vs New Deaths")# Scatterplot 2# Most recent new deaths and the total (female + male) population over 80 for # every country with date ‘2023-06-30’latest_date <- "2023-06-30"# Convert SP.POP.80UP.FE & SP.POP.80UP.MA to numeric before plottingfiltered_data <- merged_data %>%   mutate(SP.POP.80UP.FE = as.numeric(SP.POP.80UP.FE),          SP.POP.80UP.MA = as.numeric(SP.POP.80UP.MA))# Adding male and female age 80 and up populations into onefiltered_data$total_population_over_80 <- filtered_data$SP.POP.80UP.FE +   filtered_data$SP.POP.80UP.MA# Plotggplot(filtered_data, aes(x = total_population_over_80,                           y = new_deaths_smoothed)) +           geom_point() +           labs(x = "Population over 80 years (SP.POP.80UP.FE + SP.POP.80UP.MA)",               y = "New Deaths Smoothed",                title = "Population over 80 years vs New Deaths Smoothed")# Scatterplot 3# Most recent new deaths per day and the urban population.latest_date <- "2023-06-30"# Filter by datefiltered_data <- merged_data %>% filter(date == latest_date)# Plotggplot(filtered_data, aes(x = SP.URB.TOTL, y = new_deaths_smoothed)) +  geom_point() + labs(x = "Urban Population", y = "New Deaths Smoothed",                      title = "Urban Population vs New Deaths")##---------------------------- 2. LINEAR MODELING ----------------------------### Predictor Variables:#     total_vaccinations, new_cases_smoothed, total_cases, SP.POP.TOTL, #     stringency_index, median_age, gdp_per_capita, life_expectancy, #     population_density, diabetes_prevalence, cardiovase_death_rate# Generate transformed variablesmerged_data <- merged_data %>%   mutate(cardiovasc_deaths = cardiovasc_death_rate * population) %>%  mutate(total_vaccinations_per_capita =            total_vaccinations / as.numeric(SP.POP.TOTL)) %>%  mutate(economic_vulnerability_index =            (gdp_per_capita * population) / extreme_poverty) %>%   mutate(healthcare_capacity_index =            (icu_patients_per_million + hosp_patients_per_million) / 2)# Split dataset into training data and testing data for linear modeling# Training datatrainFeatures <- merged_data %>%   filter(year(date) == 2022) %>%   select(-new_deaths_smoothed_2wk)trainLabels <- merged_data %>%   filter(year(date) == 2022) %>%   select(new_deaths_smoothed_2wk) # Testing datatestFeatures <- merged_data %>%   filter(year(date) == 2023) %>%  select(-new_deaths_smoothed_2wk) testLabels <- merged_data %>%   filter(year(date) == 2023) %>%  select(new_deaths_smoothed_2wk)# Run linear regression, created 8 different linear models to test# Model 1lm1 <- lm(data = trainFeatures,           formula = trainLabels$new_deaths_smoothed_2wk ~ new_cases_smoothed +            total_vaccinations_per_capita +            median_age +            population_density +            gdp_per_capita +            life_expectancy +            stringency_index)# Model 2lm2 <- lm(data = trainFeatures,           formula = trainLabels$new_deaths_smoothed_2wk ~             new_cases_smoothed +            total_vaccinations_per_capita +            median_age +            population_density +            gdp_per_capita +            cardiovasc_death_rate)# Model 3lm3 <- lm(data = trainFeatures,           formula = trainLabels$new_deaths_smoothed_2wk ~             new_cases_smoothed +            total_vaccinations_per_capita +            median_age +            population_density +            healthcare_capacity_index)# Model 4lm4 <- lm(data = trainFeatures,           formula = trainLabels$new_deaths_smoothed_2wk ~             new_cases_smoothed +            total_vaccinations_per_capita +            median_age +            population_density +            gdp_per_capita)# Model 5lm5 <- lm(data = trainFeatures,           formula = trainLabels$new_deaths_smoothed_2wk ~             new_cases_smoothed +            total_vaccinations_per_capita +            median_age +            population_density +            cardiovasc_deaths +            diabetes_prevalence +            icu_patients +            healthcare_capacity_index)# Model 6lm6 <- lm(data = trainFeatures,           formula = trainLabels$new_deaths_smoothed_2wk ~             new_cases_smoothed +            total_vaccinations_per_capita +            median_age +            population_density +            cardiovasc_deaths +            diabetes_prevalence +            icu_patients +            healthcare_capacity_index +            economic_vulnerability_index)# Model 7lm7 <- lm(data = trainFeatures,           formula = trainLabels$new_deaths_smoothed_2wk ~             new_cases_smoothed +            total_vaccinations_per_capita +            median_age +            population_density +            gdp_per_capita +            life_expectancy +            stringency_index)# Model 8lm8 <- lm(data = trainFeatures,           formula = trainLabels$new_deaths_smoothed_2wk ~             new_cases_smoothed +            total_vaccinations_per_capita +            median_age +            population_density +            gdp_per_capita +            economic_vulnerability_index +            healthcare_capacity_index +            cardiovasc_death_rate +            diabetes_prevalence)# View the details of each model, also listing the R2 of eachsummary(lm1)      # R2: 0.2466summary(lm2)      # R2: 0.2116summary(lm3)      # R2: 0.6379summary(lm4)      # R2: 0.2107summary(lm5)      # R2: 0.9032 summary(lm6)      # R2: 0.9093summary(lm7)      # R2: 0.5834summary(lm8)      # R2: 0.7622##----------------- 3. EVALUATING THE LINEAR MODELS --------------------------### Calculate RMSE for each modelrmse_lm1 <- rmse(model = lm1, data = testFeatures)rmse_lm2 <- rmse(model = lm2, data = testFeatures)rmse_lm3 <- rmse(model = lm3, data = testFeatures)rmse_lm4 <- rmse(model = lm4, data = testFeatures)rmse_lm5 <- rmse(model = lm5, data = testFeatures)rmse_lm6 <- rmse(model = lm6, data = testFeatures)rmse_lm7 <- rmse(model = lm7, data = testFeatures)rmse_lm8 <- rmse(model = lm8, data = testFeatures)# View each RMSE valuermse_lm1rmse_lm2rmse_lm3rmse_lm4rmse_lm5rmse_lm6rmse_lm7rmse_lm8# Best model is lm5, it has lowest RMSE and 2nd highest R2.# Going to calculate RMSE of each country using lm5.# Define function to calculate RMSE for each countrycalculate_country_rmse <- function(model, data) {  data %>%    group_by(iso_code) %>%    summarise(rmse = rmse(model = model, data = cur_data()))}# Calculate RMSE for each country using the best model (lm5)country_rmse_lm5 <- calculate_country_rmse(model = lm5, data = testFeatures)# View RMSE for each countryprint(country_rmse_lm5)# Filter out NAs from country_rmse_lm5 tablecountry_rmse_lm5_no_NA <- na.omit(country_rmse_lm5)View(country_rmse_lm5_no_NA)# Arrange in decreasing ordercountry_rmse_lm5_no_NA <- country_rmse_lm5_no_NA %>% arrange(-rmse)View(country_rmse_lm5_no_NA)